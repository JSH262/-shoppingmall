<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tjoeun.shoppingmall.dao.IndexDAO">

		
	<!-- 많이 팔린 상품 목록 -->
	<select id="lotSellProductList" resultType="ProductVO">
		select *
		from (	select *
		        from (  select t.*, rownum rnum
		                from (	select id, thumbnail
		                        from product
		                        where id in (
		                                select product_id
		                                from product_order 
		                                where status = 5
		                                group by product_id
		                                having sum(product_amount) <![CDATA[ >= ]]> 50)
		                        order by id desc) t)
		        where rnum <![CDATA[ <= ]]>  5) p	
					left join
				(select avg(score) avg_review_score, count(*) as cnt_review, product_id 
				from review 
				where product_order_id is not null 
				group by product_id) ar 
					on p.id = ar.product_id
			
	</select>
		
	<!-- 신상품 목록(1개월 이내)
	<select id="newProductList" resultType="ProductVO">
		select *
		from ( 	select t.*, rownum rnum
				from (	select id, name, discount, price, thumbnail
						from product
						where to_char(create_date, 'yyyy/mm/dd hh24:mi:ss') >= to_char(add_months(sysdate, -1), 'yyyy/mm/dd hh24:mi:ss')
						order by create_date desc) t)
		where rnum <![CDATA[ <= ]]> 8
	</select>
	 -->
	<select id="newProductList" resultType="ProductVO">
		select *		
		from (	select *
				from ( 	select t.*, rownum rnum
						from (	select id, name, discount, price, thumbnail
								from product
								where to_char(create_date, 'yyyy/mm/dd hh24:mi:ss') >= to_char(add_months(sysdate, -1), 'yyyy/mm/dd hh24:mi:ss')
								order by create_date desc) t)
				where rnum <![CDATA[ <= ]]> 8) p 
					left join 
				(select avg(score) avg_review_score, count(*) as cnt_review, product_id 
				from review 
				where product_order_id is not null 
				group by product_id) ar 
					on p.id = ar.product_id 
	</select>
	<select id="productRndList" parameterType="ProductVO" resultType="ProductVO">
		select *
		from (	select *
				from (  select rownum rnum, t1.*
				        from (  select id, name, discount, price, thumbnail
				                from product
				                order by id desc) t1)
				<where>
					<foreach item="item" index="index" collection="rowList" open="rnum in (" separator="," close=")">
						#{item}
					</foreach>
				</where>
				) p 
					left join
				(select avg(score) avg_review_score, count(*) as cnt_review, product_id 
				from review 
				where product_order_id is not null 
				group by product_id) ar 
					on p.id = ar.product_id
	</select>
	
	
	<select id="reivewProductList" resultType="ProductVO">
		select *
		from (	select *
		        from (  select t.*, rownum rnum
		                from (	select id, thumbnail
		                        from product
		                        where id in (
		                                select product_id
		                                from product_order 
		                                where status = 5
		                                group by product_id
		                                having sum(product_amount) <![CDATA[ >= ]]> 50)
		                        order by id desc) t)
		        where rnum <![CDATA[ <= ]]>  5) p	
					left join
				(select avg(score) avg_review_score, count(*) as cnt_review, product_id 
				from review 
				where product_order_id is not null 
				group by product_id) ar 
					on p.id = ar.product_id
			
	</select>
	
	
	
</mapper>














